#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘              Mapache Anon - MENÃš - by MARTO              â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Package: mapache-anon
# Version: 1.0
# Section: utils
# Priority: optional
# Architecture: all
# Depends: bash, curl, tor, macchanger, openvpn, net-tools
# Maintainer: MARTO <marto.endpoint@gmail.com>
# Description: Herramienta de anonimato extremo para Kali Linux.
# Incluye cambio de MAC, VPN, Tor, DNS custom, restablecer valores y limpieza de logs.


INTERFAZ=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^[a-zA-Z0-9]+$' | grep -v 'lo' | head -n 1)
VPN_CONFIG="/etc/openvpn/anon.ovpn"
DNS_ORIGINAL="1.1.1.1"

verificar_dependencias() {
  echo "[*] Verificando dependencias necesarias..."

  paquetes=(macchanger curl openvpn tor net-tools)

  for paquete in "${paquetes[@]}"; do
    if ! dpkg -s "$paquete" &> /dev/null; then
      echo "[âœ˜] $paquete no estÃ¡ instalado. Instalando..."
      sudo apt update
      sudo apt install -y "$paquete"
    else
      echo "[âœ”] $paquete estÃ¡ instalado."
    fi
  done

  if [ ! -f "$VPN_CONFIG" ]; then
    echo "[âœ˜] Archivo de configuraciÃ³n VPN no encontrado en: $VPN_CONFIG"
    echo "    Por favor, copiÃ¡ tu archivo .ovpn ahÃ­ antes de continuar."
    exit 1
  else
    echo "[âœ”] Archivo de VPN encontrado."
  fi
}

cambiar_mac() {
  echo "[+] Cambiando direcciÃ³n MAC..."
  ip link set $INTERFAZ down
  macchanger -r $INTERFAZ
  ip link set $INTERFAZ up
}

cambiar_dns() {
  echo "[+] Cambiando DNS a DNS.Whatch (84.200.69.80 y 84.200.70.40)..."
  chattr -i /etc/resolv.conf 2>/dev/null
  echo "nameserver 84.200.69.80" > /etc/resolv.conf
  echo "nameserver 84.200.70.40" >> /etc/resolv.conf
  chattr +i /etc/resolv.conf
}

conectar_vpn() {
  echo "[+] Conectando a VPN..."
  openvpn --config "$VPN_CONFIG" --daemon
  sleep 10
}

iniciar_tor() {
  echo "[+] Iniciando Tor..."
  systemctl start tor
  sleep 5
  if systemctl is-active --quiet tor; then
    echo "[âœ”] Tor estÃ¡ corriendo correctamente."

    echo "[*] Verificando si el trÃ¡fico se enruta a travÃ©s de Tor..."
    if curl --socks5-hostname 127.0.0.1:9050 https://check.torproject.org 2>/dev/null | grep -q "Congratulations"; then
      echo "[âœ”] TrÃ¡fico redirigido por Tor correctamente."
    else
      echo "[âœ˜] El trÃ¡fico no se estÃ¡ enrutando por Tor."
    fi
  else
    echo "[âœ˜] Tor no pudo iniciarse. VerificÃ¡ si estÃ¡ instalado con: sudo apt install tor"
  fi
}

limpiar_logs() {
  echo "[+] Limpiando historial y logs..."
  cat /dev/null > ~/.bash_history
  history -c
  log_files=(
    /var/log/auth.log
    /var/log/syslog
    /var/log/kern.log
    /var/log/wtmp
    /var/log/btmp
  )
  for file in "${log_files[@]}"; do
    echo "" > "$file"
  done
  echo "[âœ”] Limpieza completada."
}

modo_basico() {
  mostrar_mapache
  cambiar_mac
  cambiar_dns
}

modo_extremo() {
  mostrar_mapache
  cambiar_mac
  cambiar_dns
  conectar_vpn
  iniciar_tor
}

restablecer_todo() {
  mostrar_mapache
  echo "[+] Restaurando configuraciÃ³n de red..."
  echo "[*] Deteniendo VPN..."
  pkill openvpn
  echo "[*] Deteniendo Tor..."
  systemctl stop tor

  echo "[*] Restaurando DNS por defecto ($DNS_ORIGINAL)..."
  chattr -i /etc/resolv.conf 2>/dev/null
  echo "nameserver $DNS_ORIGINAL" > /etc/resolv.conf
  chattr +i /etc/resolv.conf

  echo "[âœ”] ConfiguraciÃ³n restablecida. ReiniciÃ¡ la interfaz si es necesario."
}

verificar_anonimato() {
  mostrar_mapache
  echo "ğŸ” Verificando nivel de anonimato..."

  ACTUAL_MAC=$(ip link show $INTERFAZA | grep ether | awk '{print $2}')
  echo "[*] DirecciÃ³n MAC actual: $ACTUAL_MAC"
  if [[ "$ACTUAL_MAC" =~ ([0-9a-f]{2}:){5}[0-9a-f]{2} ]]; then
    echo "[âœ”] MAC parece vÃ¡lida y aleatoria."
  else
    echo "[âœ˜] MAC no se pudo verificar correctamente."
  fi

  if grep -q "84.200.69.80" /etc/resolv.conf && grep -q "84.200.70.40" /etc/resolv.conf; then
    echo "[âœ”] DNS configurados correctamente (DNS Whatch)."
  else
    echo "[âœ˜] DNS no configurados correctamente."
  fi

  VPN_IP=$(curl -s ifconfig.me)
  echo "[âœ”] IP pÃºblica actual (posiblemente vÃ­a VPN): $VPN_IP"

  # Verificar si Tor estÃ¡ escuchando en el puerto SOCKS
  echo "ğŸ”„ Verificando si Tor estÃ¡ escuchando en el puerto 9050..."
  while ! netstat -tuln | grep -q "127.0.0.1:9050"; do
    echo "[*] Tor no estÃ¡ escuchando en 127.0.0.1:9050, esperando..."
    sleep 2
  done

  echo "[âœ”] Tor estÃ¡ listo para ser utilizado."

  # Verificar Tor despuÃ©s de asegurarse de que estÃ© listo
  echo "ğŸ”„ Verificando estado de Tor..."

  # Agregar un tiempo de espera mayor para la conexiÃ³n
  sleep 10

  TOR_CHECK=$(curl -s --max-time 60 --socks5-hostname 127.0.0.1:9050 https://check.torproject.org)

  # Guardar salida para diagnÃ³stico
  echo "$TOR_CHECK" > tor_check_output.txt
  echo "[*] Salida de la verificaciÃ³n de Tor guardada en tor_check_output.txt."

  if echo "$TOR_CHECK" | grep -q "Congratulations"; then
    echo "[âœ”] Tor estÃ¡ activo y funcionando."
  else
    echo "[âœ˜] Tor no estÃ¡ funcionando o no estÃ¡ iniciado."
    echo "[*] Verifica los detalles en el archivo tor_check_output.txt."
  fi
}

mostrar_mapache() {
  for i in {1..6}; do
    clear
    cat << "EOF"
............-------...................-................-............-................................--....-------..-.........
........--+++++++++++--....................-..........--####-...-#-..................-.................--+++++++++++--........
..-..----........---+++++--.......-........-.............-+++#+.-#++-..............................--+++++---........----.....
...---...............--++++++--.......-...................-+++++++++-..........................--++++++--...............---...
..---.....----++----.....-++++++---.................-------++++##+++------......-...........--++++++--....----++----.....---..
..--....--###########-.....-+++++++--......-...---++++++++++++++++++++++++++---.-.........-+++++++--....-###########--....--..
..--....-###############-....-++++++++---..---+++++++++++++++++++++++++++++++++++--..---++++++++--...-###############+....--..
..--...-##################-....-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--.---##################-...--..
..--.-.-###################+....-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-....+###################-...--..
..--...-#####################-...-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-...-#####################-...--..
..---...+#####################..--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--..#####################+.-.---..
..--+-..-#####################++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#####################-..-+-...
....--...-####################+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++###################-...--....
.....---..-#################+++++++++++++++++++++++++++++++++-++-+++++++++++++++++++++++++++++++++#################-..---.....
......--...-##############++++++++++++++++++++++++++++++++++-.-+--++++++++++++++++++++++++++++++++++##############-...--..-...
.......-+-..-+###########+++++++++++++++++++++++++++++++++++-+----+++++++++++++++++++++++++++++++++++###########+-..-+-.......
........---...-+#######+++++++++++++++++++++++++++++++++++++-#+-#-+++++++++++++++++++++++++++++++++++++#######+-...---........
..........---...--+##+++++++++++++++++++++++++++++++++++++++-####--++++++++++++++++++++++++++++++++++++++##+--...---..........
...........-----..--+++++++++++++++++++++++++++++++++++----..-######-.-----+++++++++++++++++++++++++++++++++++--+-..............
..............----+++++++++++++++++++++++++++++++++++----..-######-.-----+++++++++++++++++++++++++++++++++++--+-..............
..-.............-+++++++++++++++++++++++++++++++++++++-###+########+###-+++++++++++++++++++++++++++++++++++++-...-............
..............-+++++++++++++++++++++++++++++++++++++++--##############+-+++++++++++++++++++++++++++++++++++++++-..............
......-.....--++++++++++++++++++++++++++++++++--+++++++-##############-+++++++--++++++++++++++++++++++++++++++++--............
............-++++++++++++++++++++++++++++++++++-.-+++++-##############-+++++-.-++++++++++++++++++++++++++++++++++-............
..........--+++++++++++++++++++++++++++++++++++--.-++++++############++++++-.--+++++++++++++++++++++++++++++++++++--.....-....
..........-++++++++++++++++++++++++++-.......----#--++-+-############-+--+--#----.......-++++++++++++++++++++++++++-........
.........-++++++++++++++++++++++++-.....-........##-+-.--############----+-##......-........++++++++++++++++++++++++-.-.......
....-...-++++++++++++++--................----....+##-..--############--..-##+.-..----................--++++++++++++++-........
........-++++++++++++++----..........-##########++##--#-.############.-#--##++##########+............--++++++++++++++-........
.......-+++++++++++++++-...--------+######++#########-##.############.+#-#########++######+--------...-+++++++++++++++-.......
....----+-+++++++++++--.-##############--.....-+########-############-########+-.....--##############-.--+++++++++++-+----....
..-------++++++++++-...--+###########+-........--#######-############-#######+-.........+###########+--...-++++++++++-------..
..-------+++++++++-.....-############-..........-#######-############-#######-..-.......-############-.....-+++++++++-------..
..------+++++++++-...--##############+..-.......-####################+#######-..........+##############--...-+++++++++------..
..------+++++++-....-#################-........-##############################-........-#################-....-+++++++------..
...----++++++++-..-+####################+-...-##################################-...-+####################+-..-++++++++----...
......-+++++++--..-########################################################################################+..--+++++++-......
......-+++++++--.+##########################################################################################+.--+++++++-......
......-++++++++--############################################################################################--++++++++-......
......-++++++++.+###################################+-.-##############---+###################################+.++++++++-....-.
......-++++++++-+################################+-.....-############-.....-+################################+-++++++++-......
......--+++++++--#############################+--........-##########+........--+#############################--+++++++--......
...-...-+-+++++--###########################--...........-##########-..........---###########################--+++++++-.......
........--++++++-#########################-..............-+#++++++##-.....-........-#########################-++++++--.-......
..........-+++++++######################-...............-+##########+-...............-######################+++++++-....-.....
.........--+++++++#####################-..............--##############-...............-#####################+++++++-..........
...........-++++++#####################+.-............-################-........-.....+#####################++++++-...........
............-++++++#####################-............-##################-............-#####################++++++-............
.............-++++++#########++++########-.........-.-##################-...........-########++++#########++++++-.............
..............--++--+##+----......---+####+..........-##################-..........+####+---......----+###--++--..............
................--..---...............--####-.........-################-.-+-.....-####--...............---..--................
........................................--+##+-...---..-##############-.---#...-+###--...............................-........
.................-........................--+##+...------+##########+---+---.-+##+--..........................................  
.............................................--+#+-...-++-....-.....-++--..-##+--.........................................-...
......................................-.........--+##+--..---+++++++--..--+#+--.....-..-.....................................-.
.....................................................--+++---------++++--..........................................-........
EOF

    echo ""
    echo "(Mapache trabajando ğŸ¦)"
    sleep 0.4
  done
}

menu() {
  while true; do
    clear
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           ğŸ¦  Mapache Anon by MARTO  ğŸ¦          â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘ 1. ğŸŒ Modo BÃ¡sico    â†’ Cambiar MAC + DNS          â•‘"
    echo "â•‘ 2. ğŸ” Modo Extremo   â†’ + VPN + Tor                â•‘"
    echo "â•‘ 3. ğŸ¦ Restablecer ConfiguraciÃ³n                   â•‘"
    echo "â•‘ 4. ğŸ§¹ Limpiar rastros y logs                      â•‘"
    echo "â•‘ 5. ğŸ” Verificar anonimato                         â•‘"
    echo "â•‘ 6. ğŸšª Salir                                       â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    read -p "SeleccionÃ¡ una opciÃ³n [1-6]: " opcion

    case $opcion in
      1) modo_basico ;;
      2) modo_extremo ;;
      3) restablecer_todo ;;
      4) limpiar_logs ;;
      5) verificar_anonimato ;;
      6) echo "Saliendo..."; exit ;;
      *) echo "OpciÃ³n invÃ¡lida."; sleep 1 ;;
    esac

    read -p "PresionÃ¡ ENTER para volver al menÃº..."
  done
}

# ğŸš€ Ejecutar verificaciÃ³n antes del menÃº
verificar_dependencias
menu
