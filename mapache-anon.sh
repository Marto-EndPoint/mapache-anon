#!/bin/bash

# ╔══════════════════════════════════════════════════════════╗
# ║              Mapache Anon - MENÚ - by MARTO              ║
# ╚══════════════════════════════════════════════════════════╝
# Package: mapache-anon
# Version: 1.0
# Section: utils
# Priority: optional
# Architecture: all
# Depends: bash, curl, tor, macchanger, openvpn, net-tools
# Maintainer: MARTO <marto.endpoint@gmail.com>
# Description: Herramienta de anonimato extremo para Kali Linux.
# Incluye cambio de MAC, VPN, Tor, DNS custom, restablecer valores y limpieza de logs.


INTERFAZ=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^[a-zA-Z0-9]+$' | grep -v 'lo' | head -n 1)
VPN_CONFIG="/etc/openvpn/anon.ovpn"
DNS_ORIGINAL="1.1.1.1"

verificar_dependencias() {
  echo "[*] Verificando dependencias necesarias..."

  paquetes=(macchanger curl openvpn tor net-tools)

  for paquete in "${paquetes[@]}"; do
    if ! dpkg -s "$paquete" &> /dev/null; then
      echo "[✘] $paquete no está instalado. Instalando..."
      sudo apt update
      sudo apt install -y "$paquete"
    else
      echo "[✔] $paquete está instalado."
    fi
  done

  if [ ! -f "$VPN_CONFIG" ]; then
    echo "[✘] Archivo de configuración VPN no encontrado en: $VPN_CONFIG"
    echo "    Por favor, copiá tu archivo .ovpn ahí antes de continuar."
    exit 1
  else
    echo "[✔] Archivo de VPN encontrado."
  fi
}

cambiar_mac() {
  echo "[+] Cambiando dirección MAC..."
  ip link set $INTERFAZ down
  macchanger -r $INTERFAZ
  ip link set $INTERFAZ up
}

cambiar_dns() {
  echo "[+] Cambiando DNS a DNS.Whatch (84.200.69.80 y 84.200.70.40)..."
  chattr -i /etc/resolv.conf 2>/dev/null
  echo "nameserver 84.200.69.80" > /etc/resolv.conf
  echo "nameserver 84.200.70.40" >> /etc/resolv.conf
  chattr +i /etc/resolv.conf
}

conectar_vpn() {
  echo "[+] Conectando a VPN..."
  openvpn --config "$VPN_CONFIG" --daemon
  sleep 10
}

iniciar_tor() {
  echo "[+] Iniciando Tor..."
  systemctl start tor
  sleep 5
  if systemctl is-active --quiet tor; then
    echo "[✔] Tor está corriendo correctamente."

    echo "[*] Verificando si el tráfico se enruta a través de Tor..."
    if curl --socks5-hostname 127.0.0.1:9050 https://check.torproject.org 2>/dev/null | grep -q "Congratulations"; then
      echo "[✔] Tráfico redirigido por Tor correctamente."
    else
      echo "[✘] El tráfico no se está enrutando por Tor."
    fi
  else
    echo "[✘] Tor no pudo iniciarse. Verificá si está instalado con: sudo apt install tor"
  fi
}

limpiar_logs() {
  echo "[+] Limpiando historial y logs..."
  cat /dev/null > ~/.bash_history
  history -c
  log_files=(
    /var/log/auth.log
    /var/log/syslog
    /var/log/kern.log
    /var/log/wtmp
    /var/log/btmp
  )
  for file in "${log_files[@]}"; do
    echo "" > "$file"
  done
  echo "[✔] Limpieza completada."
}

modo_basico() {
  mostrar_mapache
  cambiar_mac
  cambiar_dns
}

modo_extremo() {
  mostrar_mapache
  cambiar_mac
  cambiar_dns
  conectar_vpn
  iniciar_tor
}

restablecer_todo() {
  mostrar_mapache
  echo "[+] Restaurando configuración de red..."
  echo "[*] Deteniendo VPN..."
  pkill openvpn
  echo "[*] Deteniendo Tor..."
  systemctl stop tor

  echo "[*] Restaurando DNS por defecto ($DNS_ORIGINAL)..."
  chattr -i /etc/resolv.conf 2>/dev/null
  echo "nameserver $DNS_ORIGINAL" > /etc/resolv.conf
  chattr +i /etc/resolv.conf

  echo "[✔] Configuración restablecida. Reiniciá la interfaz si es necesario."
}

verificar_anonimato() {
  mostrar_mapache
  echo "🔍 Verificando nivel de anonimato..."

  ACTUAL_MAC=$(ip link show $INTERFAZA | grep ether | awk '{print $2}')
  echo "[*] Dirección MAC actual: $ACTUAL_MAC"
  if [[ "$ACTUAL_MAC" =~ ([0-9a-f]{2}:){5}[0-9a-f]{2} ]]; then
    echo "[✔] MAC parece válida y aleatoria."
  else
    echo "[✘] MAC no se pudo verificar correctamente."
  fi

  if grep -q "84.200.69.80" /etc/resolv.conf && grep -q "84.200.70.40" /etc/resolv.conf; then
    echo "[✔] DNS configurados correctamente (DNS Whatch)."
  else
    echo "[✘] DNS no configurados correctamente."
  fi

  VPN_IP=$(curl -s ifconfig.me)
  echo "[✔] IP pública actual (posiblemente vía VPN): $VPN_IP"

  # Verificar si Tor está escuchando en el puerto SOCKS
  echo "🔄 Verificando si Tor está escuchando en el puerto 9050..."
  while ! netstat -tuln | grep -q "127.0.0.1:9050"; do
    echo "[*] Tor no está escuchando en 127.0.0.1:9050, esperando..."
    sleep 2
  done

  echo "[✔] Tor está listo para ser utilizado."

  # Verificar Tor después de asegurarse de que esté listo
  echo "🔄 Verificando estado de Tor..."

  # Agregar un tiempo de espera mayor para la conexión
  sleep 10

  TOR_CHECK=$(curl -s --max-time 60 --socks5-hostname 127.0.0.1:9050 https://check.torproject.org)

  # Guardar salida para diagnóstico
  echo "$TOR_CHECK" > tor_check_output.txt
  echo "[*] Salida de la verificación de Tor guardada en tor_check_output.txt."

  if echo "$TOR_CHECK" | grep -q "Congratulations"; then
    echo "[✔] Tor está activo y funcionando."
  else
    echo "[✘] Tor no está funcionando o no está iniciado."
    echo "[*] Verifica los detalles en el archivo tor_check_output.txt."
  fi
}

mostrar_mapache() {
  for i in {1..6}; do
    clear
    cat << "EOF"
............-------...................-................-............-................................--....-------..-.........
........--+++++++++++--....................-..........--####-...-#-..................-.................--+++++++++++--........
..-..----........---+++++--.......-........-.............-+++#+.-#++-..............................--+++++---........----.....
...---...............--++++++--.......-...................-+++++++++-..........................--++++++--...............---...
..---.....----++----.....-++++++---.................-------++++##+++------......-...........--++++++--....----++----.....---..
..--....--###########-.....-+++++++--......-...---++++++++++++++++++++++++++---.-.........-+++++++--....-###########--....--..
..--....-###############-....-++++++++---..---+++++++++++++++++++++++++++++++++++--..---++++++++--...-###############+....--..
..--...-##################-....-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--.---##################-...--..
..--.-.-###################+....-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-....+###################-...--..
..--...-#####################-...-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-...-#####################-...--..
..---...+#####################..--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--..#####################+.-.---..
..--+-..-#####################++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#####################-..-+-...
....--...-####################+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++###################-...--....
.....---..-#################+++++++++++++++++++++++++++++++++-++-+++++++++++++++++++++++++++++++++#################-..---.....
......--...-##############++++++++++++++++++++++++++++++++++-.-+--++++++++++++++++++++++++++++++++++##############-...--..-...
.......-+-..-+###########+++++++++++++++++++++++++++++++++++-+----+++++++++++++++++++++++++++++++++++###########+-..-+-.......
........---...-+#######+++++++++++++++++++++++++++++++++++++-#+-#-+++++++++++++++++++++++++++++++++++++#######+-...---........
..........---...--+##+++++++++++++++++++++++++++++++++++++++-####--++++++++++++++++++++++++++++++++++++++##+--...---..........
...........-----..--+++++++++++++++++++++++++++++++++++----..-######-.-----+++++++++++++++++++++++++++++++++++--+-..............
..............----+++++++++++++++++++++++++++++++++++----..-######-.-----+++++++++++++++++++++++++++++++++++--+-..............
..-.............-+++++++++++++++++++++++++++++++++++++-###+########+###-+++++++++++++++++++++++++++++++++++++-...-............
..............-+++++++++++++++++++++++++++++++++++++++--##############+-+++++++++++++++++++++++++++++++++++++++-..............
......-.....--++++++++++++++++++++++++++++++++--+++++++-##############-+++++++--++++++++++++++++++++++++++++++++--............
............-++++++++++++++++++++++++++++++++++-.-+++++-##############-+++++-.-++++++++++++++++++++++++++++++++++-............
..........--+++++++++++++++++++++++++++++++++++--.-++++++############++++++-.--+++++++++++++++++++++++++++++++++++--.....-....
..........-++++++++++++++++++++++++++-.......----#--++-+-############-+--+--#----.......-++++++++++++++++++++++++++-........
.........-++++++++++++++++++++++++-.....-........##-+-.--############----+-##......-........++++++++++++++++++++++++-.-.......
....-...-++++++++++++++--................----....+##-..--############--..-##+.-..----................--++++++++++++++-........
........-++++++++++++++----..........-##########++##--#-.############.-#--##++##########+............--++++++++++++++-........
.......-+++++++++++++++-...--------+######++#########-##.############.+#-#########++######+--------...-+++++++++++++++-.......
....----+-+++++++++++--.-##############--.....-+########-############-########+-.....--##############-.--+++++++++++-+----....
..-------++++++++++-...--+###########+-........--#######-############-#######+-.........+###########+--...-++++++++++-------..
..-------+++++++++-.....-############-..........-#######-############-#######-..-.......-############-.....-+++++++++-------..
..------+++++++++-...--##############+..-.......-####################+#######-..........+##############--...-+++++++++------..
..------+++++++-....-#################-........-##############################-........-#################-....-+++++++------..
...----++++++++-..-+####################+-...-##################################-...-+####################+-..-++++++++----...
......-+++++++--..-########################################################################################+..--+++++++-......
......-+++++++--.+##########################################################################################+.--+++++++-......
......-++++++++--############################################################################################--++++++++-......
......-++++++++.+###################################+-.-##############---+###################################+.++++++++-....-.
......-++++++++-+################################+-.....-############-.....-+################################+-++++++++-......
......--+++++++--#############################+--........-##########+........--+#############################--+++++++--......
...-...-+-+++++--###########################--...........-##########-..........---###########################--+++++++-.......
........--++++++-#########################-..............-+#++++++##-.....-........-#########################-++++++--.-......
..........-+++++++######################-...............-+##########+-...............-######################+++++++-....-.....
.........--+++++++#####################-..............--##############-...............-#####################+++++++-..........
...........-++++++#####################+.-............-################-........-.....+#####################++++++-...........
............-++++++#####################-............-##################-............-#####################++++++-............
.............-++++++#########++++########-.........-.-##################-...........-########++++#########++++++-.............
..............--++--+##+----......---+####+..........-##################-..........+####+---......----+###--++--..............
................--..---...............--####-.........-################-.-+-.....-####--...............---..--................
........................................--+##+-...---..-##############-.---#...-+###--...............................-........
.................-........................--+##+...------+##########+---+---.-+##+--..........................................  
.............................................--+#+-...-++-....-.....-++--..-##+--.........................................-...
......................................-.........--+##+--..---+++++++--..--+#+--.....-..-.....................................-.
.....................................................--+++---------++++--..........................................-........
EOF

    echo ""
    echo "(Mapache trabajando 🦝)"
    sleep 0.4
  done
}

menu() {
  while true; do
    clear
    echo "╔═══════════════════════════════════════════════════╗"
    echo "║           🦝  Mapache Anon by MARTO  🦝          ║"
    echo "╠═══════════════════════════════════════════════════╣"
    echo "║ 1. 🌐 Modo Básico    → Cambiar MAC + DNS          ║"
    echo "║ 2. 🔐 Modo Extremo   → + VPN + Tor                ║"
    echo "║ 3. 🦝 Restablecer Configuración                   ║"
    echo "║ 4. 🧹 Limpiar rastros y logs                      ║"
    echo "║ 5. 🔎 Verificar anonimato                         ║"
    echo "║ 6. 🚪 Salir                                       ║"
    echo "╚═══════════════════════════════════════════════════╝"
    read -p "Seleccioná una opción [1-6]: " opcion

    case $opcion in
      1) modo_basico ;;
      2) modo_extremo ;;
      3) restablecer_todo ;;
      4) limpiar_logs ;;
      5) verificar_anonimato ;;
      6) echo "Saliendo..."; exit ;;
      *) echo "Opción inválida."; sleep 1 ;;
    esac

    read -p "Presioná ENTER para volver al menú..."
  done
}

# 🚀 Ejecutar verificación antes del menú
verificar_dependencias
menu
